require 'fileutils'

#default_platform(:android)

platform :android do

  ####################################################
  # ğŸŸ¢ Helper methods
  ####################################################

  def extract_locales
    project_root = File.expand_path("..", __dir__)
    arb_files = Dir[File.join(project_root, "lib/l10n/app_*.arb")]
    locales = arb_files.map { |file| file.match(/app_(.+)\.arb/)[1] }
    locales.uniq
  end

  def to_play_locale(locale)
    {
      "en" => "en-US",
      "fr" => "fr-FR",
      "pt" => "pt-PT",
      "es" => "es-ES",
      "de" => "de-DE"
    }[locale] || locale
  end

  ####################################################
  # ğŸ“¸ Screenshots multilingues
  ####################################################

  desc "ğŸ“¸ GÃ©nÃ©rer les screenshots Android multilingues"
  lane :screenshots do
    project_root = File.expand_path("..", __dir__)
    dart_script = File.join(project_root, "/fastlane/generate_metadata.dart")

    unless File.exist?(dart_script)
      UI.user_error!("âŒ Script Dart introuvable: #{dart_script}")
    end


      # DÃ©marrer l'Ã©mulateur si besoin
     # UI.message("ğŸš€ Lancement de l'Ã©mulateur Android...")
     # sh("emulator -avd  Pixel_7_Pro_API_34 -no-snapshot-load -no-window &")
     # sleep(60) # Temps de dÃ©marrage de l'Ã©mulateur


    Dir.chdir(project_root) do
      sh("dart '#{dart_script}'")
    end

    locales = extract_locales
    if locales.empty?
      UI.user_error!("âŒ Aucune locale trouvÃ©e dans lib/l10n")
    end


    # Nettoyer les captures d'Ã©cran avant de gÃ©nÃ©rer
    screenshots_dir = File.join(project_root, "test_driver/screenshots")
    FileUtils.rm_rf(screenshots_dir)
    FileUtils.mkdir_p(screenshots_dir)
    UI.message("ğŸ§¹ Dossier screenshots nettoyÃ©.")

    locales.each do |locale|
      UI.message("ğŸŒ Locale : #{locale}")

      # Build l'app avec la locale
      sh("flutter build apk --dart-define=LOCALE=#{locale}")

      # Lancer les tests d'intÃ©gration
      sh("flutter drive --driver=test_driver/integration_test.dart --target=test_driver/app.dart -d emulator-5554 --dart-define=LOCALE=#{locale} --screenshot=test_driver/screenshots")

      play_locale = to_play_locale(locale)
      dest_dir = File.join(project_root, "fastlane/metadata/android/#{play_locale}/images/phoneScreenshots")
      FileUtils.mkdir_p(dest_dir)

       # VÃ©rifier la prÃ©sence de captures d'Ã©cran avant de copier
       screenshots = Dir["test_driver/screenshots/*.png"]
       if screenshots.empty?
         UI.important("Aucune capture d'Ã©cran trouvÃ©e pour la locale #{locale} dans test_driver/screenshots/")
       else
         sh("cp test_driver/screenshots/*.png '#{dest_dir}/'")
       end
    end
  end

  ####################################################
  # ğŸš€ Release Google Play
  ####################################################

  desc "ğŸš€ Publier Android (metadata + screenshots)"
  lane :release do
    screenshots
    supply(
      skip_upload_apk: true,
      skip_upload_aab: true,
      skip_upload_changelogs: true,
      skip_upload_metadata: false,
      skip_upload_screenshots: false
    )
  end

  ####################################################
  # âœ… Tests unitaires
  ####################################################

  desc "âœ… Lancer les tests unitaires Android"
  lane :test do
    gradle(
      task: "testReleaseUnitTest"
    )
  end

end
